<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNY 360 Web Interface</title>
</head>
<body>
    <div>
        <form action="/api/connect" method="POST">
            <input type="text" name="ssid" placeholder="SSID">
            <input type="password" name="password" placeholder="Password">
            <button type="submit">Connect</button>
        </form>
    </div>
    <hr>
    <h1>Motor control</h1>
    <div id="motors-container">
        <script>
            const container = document.getElementById('motors-container');
            const numberOfMotors = 12;
            const angleBounds = [
                [-45, 45],
                [-135, 45],
                [0, 135],
                [-45, 45],
                [-135, 45],
                [0, 135],
                [-45, 45],
                [-135, 45],
                [0, 135],
                [-45, 45],
                [-135, 45],
                [0, 135],
            ];
            const names = [
                "Hip Roll FL",
                "Hip Pitch FL",
                "Knee Pitch FL",
                "Hip Roll FR",
                "Hip Pitch FR",
                "Knee Pitch FR",
                "Hip Roll BL",
                "Hip Pitch BL",
                "Knee Pitch BL",
                "Hip Roll BR",
                "Hip Pitch BR",
                "Knee Pitch BR",
            ];

            for (let i = 0; i < numberOfMotors; i++) {
                const motorDiv = document.createElement('div');
                motorDiv.style.marginBottom = '10px';
                motorDiv.style.border = '1px solid #ccc';
                motorDiv.style.padding = '10px';

                const label = document.createElement('strong');
                label.textContent = `Motor ${names[i]}: `;
                motorDiv.appendChild(label);

                const sliderText = document.createElement('span');

                // Slider
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = angleBounds[i][0].toString();
                slider.max = angleBounds[i][1].toString();
                slider.step = '1';
                slider.value = ((angleBounds[i][0] + angleBounds[i][1]) / 2).toString();
                slider.style.width = '1200px';
                slider.oninput = function() {
                    fetch('/api/position', {
                        method: 'POST',
                        body: `${i},${parseInt(this.value)}`
                    });
                    sliderText.textContent = ` ${this.value}° `;
                };
                sliderText.textContent = ` ${slider.value}° `;
                motorDiv.appendChild(slider);
                motorDiv.appendChild(sliderText);

                // Enable/Disable Button
                const EnableButton = document.createElement('button');
                EnableButton.textContent = 'Enable';
                let isEnabled = false;
                EnableButton.onclick = function() {
                    isEnabled = !isEnabled;
                    EnableButton.textContent = isEnabled ? 'Disable' : 'Enable';
                    fetch('/api/enable', {
                        method: 'POST',
                        body: `${i},${isEnabled ? 1 : 0}`
                    });
                };
                motorDiv.appendChild(EnableButton);

                // Calibrate Button
                const CalibrateButton = document.createElement('button');
                CalibrateButton.textContent = 'Calibrate';
                CalibrateButton.onclick = function() {
                    fetch('/api/calibrate', {
                        method: 'POST',
                        body: `${i}`
                    });
                };
                motorDiv.appendChild(CalibrateButton);

                const feedBackText = document.createElement("span");
                feedBackText.id = `motor-feedback-${i}`;
                motorDiv.appendChild(feedBackText);

                container.appendChild(motorDiv);
            }

            setInterval(() => {
                fetch('/api/feedback')
                .then(response => response.text())
                .then(data => {
                    const feedbacks = data.split(',');
                    feedbacks.forEach((value, index) => {
                        const feedbackElement = document.getElementById(`motor-feedback-${index}`);
                        if (feedbackElement) {
                            feedbackElement.textContent = ` | Feedback: ${value}°`;
                        }
                    });
                });
            }, 500);
        </script>
    </div>
    <hr>
    <h1>IK</h1>
    <div id="ik-container">
        <script>
            const ikContainer = document.getElementById('ik-container');
            const legs = ['FL', 'FR', 'BL', 'BR'];
            legs.forEach((leg, index) => {
                const legDiv = document.createElement('div');
                legDiv.style.marginBottom = '10px';

                const label = document.createElement('strong');
                label.textContent = `Leg ${leg}: `;
                legDiv.appendChild(label);

                const ranges = {
                    'X': [-100, 100],
                    'Y': [-100, 100],
                    'Z': [-200, 0]
                };

                ['X', 'Y', 'Z'].forEach(axis => {
                    const inputDiv = document.createElement('div');
                    inputDiv.style.display = 'inline-block';
                    inputDiv.style.marginRight = '20px';
                    const span = document.createElement('span');
                    span.textContent = `${axis}: `;
                    const input = document.createElement('input');
                    input.id = `ik-input-${leg}-${axis}`;
                    input.type = 'range';
                    input.min = (ranges[axis][0]).toString();
                    input.max = (ranges[axis][1]).toString();
                    input.value = '0';
                    input.step = '1';
                    input.placeholder = `${axis}`;
                    input.style.width = '300px';
                    const result = document.createElement('span');
                    result.id = `ik-result-${leg}-${axis}`;
                    result.style.marginLeft = '6px';
                    input.oninput = function() {
                        result.textContent = ` ${this.value} `;
                        const x = legDiv.querySelector('input[id="ik-input-' + leg + '-X"]').value || 0;
                        const y = legDiv.querySelector('input[id="ik-input-' + leg + '-Y"]').value || 0;
                        const z = legDiv.querySelector('input[id="ik-input-' + leg + '-Z"]').value || 0;
                        fetch('/api/ik', {
                            method: 'POST',
                            body: `${index},${x},${y},${z}`
                        });
                    };
                    result.textContent = ` ${input.value} `;
                    inputDiv.appendChild(span);
                    inputDiv.appendChild(input);
                    inputDiv.appendChild(result);
                    legDiv.appendChild(inputDiv);
                });

                ikContainer.appendChild(legDiv);
            });
        </script>
    </div>
    <hr>
    <h1>Body Posture</h1>
    <div id="body-container">
        <script>
                    const bodyContainer = document.getElementById('body-container');
                    const axes = [
                        { id: 'RotX', name: 'Rotation X (Roll)', min: -45, max: 45, val: 0 },
                        { id: 'RotY', name: 'Rotation Y (Pitch)', min: -45, max: 45, val: 0 },
                        { id: 'RotZ', name: 'Rotation Z (Yaw)',   min: -45, max: 45, val: 0 },
                        { id: 'PosX', name: 'Position X',         min: -100, max: 100, val: 0 },
                        { id: 'PosY', name: 'Position Y',         min: -100, max: 100, val: 0 },
                        { id: 'PosZ', name: 'Position Z',         min: 0,    max: 200, val: 100 } // Default slightly up
                    ];

                    axes.forEach(axis => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';

                        const label = document.createElement('strong');
                        label.textContent = `${axis.name}: `;
                        div.appendChild(label);

                        const input = document.createElement('input');
                        input.id = `body-${axis.id}`;
                        input.type = 'range';
                        input.min = axis.min.toString();
                        input.max = axis.max.toString();
                        input.value = axis.val.toString();
                        input.step = '1';
                        input.style.width = '300px';
                        
                        const valDisplay = document.createElement('span');
                        valDisplay.style.marginLeft = '10px';
                        valDisplay.textContent = input.value;

                        input.oninput = function() {
                            valDisplay.textContent = this.value;
                            
                            // Gather all current values
                            const rx = document.getElementById('body-RotX').value;
                            const ry = document.getElementById('body-RotY').value;
                            const rz = document.getElementById('body-RotZ').value;
                            const px = document.getElementById('body-PosX').value;
                            const py = document.getElementById('body-PosY').value;
                            const pz = document.getElementById('body-PosZ').value;

                            // Send to API: rotx,roty,rotz,posx,posy,posz
                            // Matches: sscanf(buf, "%f,%f,%f,%f,%f,%f", &rotx, &roty, &rotz, &posx, &posy, &posz)
                            fetch('/api/body', {
                                method: 'POST',
                                body: `${rx},${ry},${rz},${px},${py},${pz}`
                            });
                        };

                        div.appendChild(input);
                        div.appendChild(valDisplay);
                        bodyContainer.appendChild(div);
                    });
                </script>
    </div>
    <hr>
    <h1>Voltages</h1>
    <div id="voltages-container">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const voltagesContainer = document.getElementById('voltages-container');

            // --- 1. Dynamic CSS Styles ---
            const style = document.createElement('style');
            style.textContent = `
                .chart-wrapper {
                    position: relative;
                    height: 200px;
                    width: 450px;
                }
                .overlay-val {
                    position: absolute;
                    top: 0;
                    right: 0;
                    background: rgba(255, 255, 255, 0.7);
                    padding: 2px 5px;
                    font-weight: bold;
                    font-size: 0.8em;
                }
                .voltage-table {
                    width: 100%;
                    border-collapse: collapse;
                    border: 1px solid black;
                }
                .voltage-table th, .voltage-table td {
                    border: 1px solid black;
                }
            `;
            voltagesContainer.appendChild(style);

            // --- 2. Build the Table Structure ---
            const table = document.createElement('table');
            table.className = 'voltage-table';

            // Table Head
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Part', 'FL', 'FR', 'BL', 'BR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Table Body
            const tbody = document.createElement('tbody');
            const rowsConfig = [
                { label: 'Hip Roll',   startIndex: 0 },
                { label: 'Hip Pitch',  startIndex: 1 },
                { label: 'Knee Pitch', startIndex: 2 },
                { label: 'Paw FSR',    startIndex: 12 } // 12, 13, 14, 15
            ];

            // Helper to create chart cell
            function createChartCell(chartIndex) {
                const td = document.createElement('td');
                
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-wrapper';

                const canvas = document.createElement('canvas');
                canvas.id = `chart-${chartIndex}`;
                
                const span = document.createElement('span');
                span.id = `val-${chartIndex}`;
                span.className = 'overlay-val';
                span.textContent = '0V';

                wrapper.appendChild(canvas);
                wrapper.appendChild(span);
                td.appendChild(wrapper);
                return td;
            }

            rowsConfig.forEach(rowInfo => {
                const tr = document.createElement('tr');
                
                // Label Cell
                const labelTd = document.createElement('td');
                const strong = document.createElement('strong');
                strong.textContent = rowInfo.label;
                labelTd.appendChild(strong);
                tr.appendChild(labelTd);

                if (rowInfo.label === 'Paw FSR') {
                     // The FSRs are linear 12, 13, 14, 15
                     for (let i = 0; i < 4; i++) {
                        tr.appendChild(createChartCell(rowInfo.startIndex + i));
                     }
                } else {
                    // The Motors are interleaved
                    // Hip Roll  : 0, 3, 6, 9
                    // Hip Pitch : 1, 4, 7, 10
                    // Knee Pitch: 2, 5, 8, 11
                    for (let i = 0; i < 4; i++) {
                        tr.appendChild(createChartCell(rowInfo.startIndex + (i * 3)));
                    }
                }
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            voltagesContainer.appendChild(table);

            // --- 3. Initialize Chart Logic ---
            // Note: The logic inside specific cells (0,3,6,9 etc) aligns with the manual table 
            // layout provided in the original code, assuming the chart-IDs map 1-to-1.

            const numCharts = 16;
            const maxDataPoints = 50;
            const charts = [];

            // Initialize charts
            for (let i = 0; i < numCharts; i++) {
                const ctx = document.getElementById(`chart-${i}`).getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(maxDataPoints).fill(''),
                        datasets: [{
                            label: 'Voltage (V)',
                            data: Array(maxDataPoints).fill(0),
                            borderColor: 'blue',
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            x: { display: false },
                            y: {
                                min: 0,
                                max: 3.3,
                                ticks: { display: true }
                            }
                        },
                        plugins: { legend: { display: false } },
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false
                    }
                });
                charts.push(chart);
            }

            setInterval(() => {
                fetch('/api/voltages', { method: 'GET' })
                .then(response => response.text())
                .then(data => {
                    // Expected format: "mv1,mv2,mv3,..." (e.g. "3300,1200,0,500...")
                    if(!data) return;
                    const voltagesMv = data.split(',');
                    voltagesMv.forEach((mvStr, index) => {
                        if (index < charts.length) {
                            const voltageV = parseInt(mvStr) / 1000.0;
                            const chart = charts[index];

                            // Update text overlay
                            const valElem = document.getElementById(`val-${index}`);
                            if (valElem) valElem.textContent = voltageV.toFixed(2) + 'V';

                            // Update chart data
                            const dataset = chart.data.datasets[0].data;
                            dataset.push(voltageV);
                            if (dataset.length > maxDataPoints) {
                                dataset.shift();
                            }
                            chart.update();
                        }
                    });
                })
                .catch(err => console.error('Error fetching voltages:', err));
            }, 200);
        </script>
    </div>
</body>
</html>